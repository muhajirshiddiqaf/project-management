name: Dependency Check

on:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  dependency-check:
    name: Check Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        cd backend && npm ci
        cd ../frontend && npm ci

    - name: Check for outdated dependencies
      run: |
        echo "Checking for outdated dependencies..."
        cd backend && npm outdated || true
        cd ../frontend && npm outdated || true

    - name: Run npm audit
      run: |
        cd backend && npm audit --audit-level=moderate
        cd ../frontend && npm audit --audit-level=moderate

    - name: Check for security vulnerabilities
      run: |
        echo "Checking for security vulnerabilities..."
        cd backend && npm audit --audit-level=high
        cd ../frontend && npm audit --audit-level=high

  license-check:
    name: License Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install license checker
      run: npm install -g license-checker

    - name: Check licenses
      run: |
        cd backend && license-checker --summary
        cd ../frontend && license-checker --summary

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install frontend dependencies
      run: |
        cd frontend && npm ci

    - name: Build frontend
      run: |
        cd frontend && npm run build

    - name: Check bundle size
      run: |
        echo "Checking bundle size..."
        cd frontend
        du -sh build/ || true
